# Intent Router Backend

## Setup

1. `cd server`
2. `npm install`
3. `cp .env.example .env`
4. Set provider in `.env` using `LLM_PROVIDER`
5. `npm run dev`

## Provider Options

### 1) Cloudflare Workers AI (Llama 70B)

In `.env`:
- `LLM_PROVIDER=cloudflare`
- `CLOUDFLARE_ACCOUNT_ID=...`
- `CLOUDFLARE_API_TOKEN=...`
- `CLOUDFLARE_MODEL=@cf/meta/llama-3.1-70b-instruct`

Get Account ID from Cloudflare dashboard and create an API token with Workers AI permissions.

### 2) OpenAI

In `.env`:
- `LLM_PROVIDER=openai`
- `OPENAI_API_KEY=...`

### 3) Ollama (local)

In `.env`:
- `LLM_PROVIDER=ollama`
- `OLLAMA_MODEL=llama3.2:3b`

### 4) Fallback rules-only mode

In `.env`:
- `LLM_PROVIDER=fallback`

## API

### `GET /health`

Health check.

### `GET /api/options`

Returns allowed values for category/tags/mode.

### `POST /api/classify-intent`

Request:

```json
{
  "text": "I need help with recursion before tomorrow's quiz"
}
```

Response shape:

```json
{
  "category": "academic",
  "tags": ["algorithms", "exam-prep"],
  "topic_label": "Recursion quiz prep",
  "mode": "help"
}
```

Rules enforced by server:
- `category` must be one allowed category
- `tags` must contain 2+ allowed tags
- `mode` must be one of `help | offer | group`
- `topic_label` is generated by the model and validated

## Test with curl

```bash
curl -X POST http://localhost:4000/api/classify-intent \
  -H "Content-Type: application/json" \
  -d '{"text":"let\'s discuss quiz details tonight"}'
```

### `POST /post-request`

Request:

```json
{
  "text": "Need help with recursion before tomorrow",
  "urgency": "high",
  "user_id": "user-123"
}
```

`user_id` can also be passed in header `x-user-id`.

Behavior:
- Classifies intent from `text`
- Saves request with `status=OPEN`
- Finds best OPEN candidate request where `user_id` is different
- Score formula:
  - `+10` per shared tag
  - `+15` same category
  - `+10` same subject
  - freshness bonus (newer requests score higher)
- If best score is `>= MATCH_THRESHOLD` (default `30`):
  - Creates direct room
  - Marks both requests as `MATCHED`
  - Returns `room_id`, `score`, `reasons`
- If no good match:
  - Creates/fetches topic room by `(category + first_tag)`
  - Adds user to that room
  - Keeps request `OPEN`
  - Returns `room_id`

Example match response:

```json
{
  "room_id": "2d41e95d-5de2-4eaa-a459-004b3a7dcebf",
  "score": 65,
  "reasons": [
    "shared tag: algorithms",
    "same category: academics"
  ]
}
```
